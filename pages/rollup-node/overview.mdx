import { Tabs, Tab } from 'nextra/components'
import { Callout } from 'nextra/components'

# Rollup Node

<Callout type="info" emoji="ðŸ’¡">
To set up and run the rollup node, please follow the step-by-step instructions in [Run Rollup Node](/development/run-rollup-node) guide. This page focuses more on the specification overview of the rollup node's functionality and architecture.
</Callout>

![](/img/rollup.png)

## Overview

- A rollup node can manage multiple database (DB) instances.
- The admin user has the authority to add, update, or remove database instances.
- Upon the addition of a database, the gateway node initiates a rollup child process. This process includes a Layer 2 (L2) DB, a Write-Ahead Logging (WAL) DB, and plugin DBs, all of which are offchain instances of WeaveDB.
- If a Layer 1 (L1) DB contract is deployed and rollup is enabled, the rollup process starts an additional child process for the Warp SDK. This process bundles L2 transactions and synchronizes them with the Warp sequencer in parallel.
- The L1 WeaveDB contract is capable of receiving bundled transactions that arrive in parallel and in any sequence. It can determine the correct transaction order and compute the exact same state as the L2 contract by resolving the correct order.  L2 transaction hashes are chained in such a way that the L1 contract can determine the order of L2 transactions.
- When the WeaveDB Gateway receives an L2 query, it dispatches the query to the L2 DB within the rollup process. This, in turn, triggers a query in the WAL DB, which may then cause subsequent queries in the offchain plugin DBs.
- In the absence of local cache, the rollup node is capable of reconstructing the L2 DB state from the corresponding L1 contract.
- Direct queries to the DB on the L1 Warp contract are possible since L2 and L1 share the same contract structure. The delay on L1 is minimal, typically only a few seconds, since the rollup process typically completes in under 2 seconds.

## Config File

1. Open the [WeaveDB repo](/development/clone-the-repo) in Visual Studio Code or your preferred code editor.

2. Navigate to `/grpc-node/node-server/` directory and create a file named `weavedb.standalone.config.js` if it does not already exist.

### Required Parameters

- `admin` : The admin EVM private key for the rollup node. The admin can add databases to the node.
- `bundler` : Arweave RSA keys for the rollup bundler. The bundler will pay for rollup transactions and, in the future, receive rewards from Proof of Stake (PoS).
- `rollups` :  This can be either empty or filled with pre-defined database instances. Each key represents the database name.
        - `secure` : Passed down to the contract's initial state. Always use true in production (default).
        - `owner` : The database contract owner's EVM address.
        - `tick` : Time span in milliseconds during which the [tick](/sdk/crons#tick) query will be periodically executed.
        - `contractTxId` : Warp L1 contractTxId.
        - `plugins` : Add offchain plugins. Plugin scripts must be placed in `/grpc-node/node-server/plugins` with the same name.
        - `rollup` : A bloolean value to enable rollup to Arweave/Warp

```js copy filename="/grpc-node/node-server/weavedb.standalone.config.js"
module.exports = {
  admin: EVM_PRIVATE_KEY,
  bundler: ARWEAVE_RSA_KEYS,
  rollups: {},
}
```

### Other Parameters

- `dir` : Cache directory, defaults to `/grpc-node/node-server/cache`
- `dbname` : Cache database name. The cache will be stored in `dir/dbname`
- `nostr` : Enable WebSocket for Nostr. This turns the node into a Nostr relay.
  - `db` : The database name for Nostr events. There can be only one DB instance to receive Nostr events.

### Complete Config Sample

Replace the placeholder values with the necessary information.

```js copy filename="/grpc-node/node-server/weavedb.standalone.config.js"
module.exports = {
  dir: "/home/xyz/cache",
  dbname: "mydb",
  admin: "privateky...",
  bundler: {
    kty: "RSA",
	...
  },
  nostr: { db: "nostr" },
  rollups: {
    testdb: {
	  secure: true,
	  owner: "0xdef...",
	  tick: 1000 * 60 * 5,
	  contractTxId: "abcdef...",
	  rollup: true,
	  plugins: { notifications: {} },
	},
	nostr: {
	  owner: "0xdef...",
	  rollup: false,
	}
  },
}
```

## Auto Recovery

If `contractTxId` is specified and the rollup node is reinitialized without its cache, it will automatically recover the state of the rollup database from the Warp Layer 1 transaction history.

## Admin Operations

This guide outlines the procedures to assist administrators with Externally Owned Accounts (EOAs) in managing rollup nodes and database instances remotely.

By following these instructions, you will set up the necessary tools and scripts to perform admin operations.

- Create a new empty folder on your machine and add a file for each of the operations below.

- Open a terminal, navigate to your folder path, and run the following command to install `weavedb-node-client`

<Tabs items={['yarn', 'npm']}>
  <Tab>
  ```bash copy
yarn add weavedb-node-client
  ```
  </Tab>
  <Tab>
  ```bash copy
npm install weavedb-node-client
  ```
  </Tab>
</Tabs>

### Get Rollup Node Info

Inside your folder, create a file named `get-node-info.js` if it does not already exist.

Copy the script below, paste it into the `get-node-info.js` file, and replace the placeholder values with the necessary information.

```js copy filename="/get-node-info.js"
const WeaveDB = require("weavedb-node-client")

const db = new WeaveDB({
  rpc: "localhost:8080",
  contractTxId: "CONTRACT_TX_ID", // Replace 'CONTRACT_TX_ID' with an existing deployed database contract on the rollup node
})

const main = async () => {
  const stats = await db.node({ op: "stats" })
  console.log("stats", stats)
}

main()
```

Run the following script in the terminal to display the rollup node stats, which include information about the deployed databases.

```bash copy
node get-node-info.js
```

### Add Database Instance

Inside your folder, create a file named `add.js` if it does not already exist.

Copy the script below, paste it in `add.js` file, and replace the placeholder values with the necessary information.

```js copy filename="/add.js"
const WeaveDB = require("weavedb-node-client")

const db = new WeaveDB({
  rpc: "localhost:8080",
  contractTxId: "CONTRACT_TX_ID", // Replace 'CONTRACT_TX_ID' with an existing deployed database contract on the rollup node
})

const main = async () => {
  const tx = await db.admin(
    {
      op: "add_db",
      key: "CONTRACT_DB_NAME", // Replace 'CONTRACT_DB_NAME' with your actual contract database name
      db: {
        app: "http://localhost:3000",
        name: "DB_INSTANCE", // Replace 'DB_INSTANCE' with your actual database instance
        rollup: false, // Set this to true to deploy your database to roll up to the Layer 1 Warp contract
        plugins: { notifications: {} },
        tick: 1000 * 60 * 5,
      },
    },
    {
      privateKey: "ADMIN_PRIVATE_KEY", // Replace 'ADMIN_PRIVATE_KEY' with the actual admin private key
    }
  )
}

main()
```

Run the following script in the terminal. 

```bash copy
node scripts/add.js
```

### Deploy Warp L1 Contract

Inside your folder, create a file named `deploy.js` if it does not already exist.

Copy the script below, paste it in `deploy.js` file, and replace the placeholder values with the necessary information.

```js copy filename="/deploy.js"
const WeaveDB = require("weavedb-node-client")

const db = new WeaveDB({
  rpc: "localhost:8080",
  contractTxId: "CONTRACT_TX_ID", // Replace 'CONTRACT_TX_ID' with an existing deployed database contract on the rollup node
})

const main = async () => {
  const { contractTxId, srcTxId } = await db.admin(
    { op: "deploy_contract", key: "CONTRACT_DB_NAME" }, // Replace 'CONTRACT_DB_NAME' with your actual contract database name
    {
      privateKey: "ADMIN_PRIVATE_KEY", // Replace 'ADMIN_PRIVATE_KEY' with the actual admin private key
    }
  )
}

main()
```

Run the following script in the terminal. 

```bash copy
node scripts/deploy.js
```

{/* ### Update Database Instance

Inside your folder, create a file named `update.js` if it does not already exist.

Copy the script below, paste it in `update.js` file, and replace the placeholder values with the necessary information.

```js copy filename="/update.js"
const WeaveDB = require("weavedb-node-client")

const db = new WeaveDB({
  rpc: "localhost:8080",
  contractTxId: "CONTRACT_TX_ID", // Replace 'CONTRACT_TX_ID' with an existing deployed database contract on the rollup node
})

const main = async () => {
  const tx = await db.admin(
    { op: "update_db", key: "CONTRACT_DB_NAME" }, // Replace 'CONTRACT_DB_NAME' with your actual contract database name
    {
      privateKey: "ADMIN_PRIVATE_KEY", // Replace 'ADMIN_PRIVATE_KEY' with the actual admin private key
    }
  )
}

main()
```

Run the following script in the terminal. 

```bash copy
node scripts/update.js
``` */}

### Remove Database Instance

Inside your folder, create a file named `remove.js` if it does not already exist.

Copy the script below, paste it in `remove.js` file, and replace the placeholder values with the necessary information.

```js copy filename="/remove.js"
const WeaveDB = require("weavedb-node-client")

const db = new WeaveDB({
  rpc: "localhost:8080",
  contractTxId: "CONTRACT_TX_ID", // Replace 'CONTRACT_TX_ID' with an existing deployed database contract on the rollup node
})

const main = async () => {
  const tx = await db.admin(
    { op: "remove_db", key: "CONTRACT_DB_NAME" }, // Replace 'CONTRACT_DB_NAME' with your actual contract database name
    {
      privateKey: "ADMIN_PRIVATE_KEY", // Replace 'ADMIN_PRIVATE_KEY' with the actual admin private key
    }
  )
}

main()
```

Run the following script in the terminal. 

```bash copy
node scripts/remove.js
```

### Query Database

You will need the L1 `contractTxId` from the [deployment operation](/rollup-node/overview#deploy-warp-l1-contract) to instantiate the DB client.  
All L2 transactions will be signed with L1 `contractTxId` for L1/L2 verifiability.

Inside your folder, create a file named `query.js` if it does not already exist.

Copy the script below, paste it in `query.js` file, and replace the placeholder values with the necessary information.

```js copy filename="/query.js"
const WeaveDB = require("weavedb-node-client")

const db = new WeaveDB({
  rpc: "localhost:8080",
  contractTxId: "CONTRACT_TX_ID", // Replace 'CONTRACT_TX_ID' with an existing deployed database contract on the rollup node
})

const main = async () => {
  const db_info = await db.getInfo()
  console.log("db_info", db_info)
}

main()

```

Run the following script in the terminal. 

```bash copy
node scripts/query.js
```

## Plugins

We currently have only one plugin for [Jots](/development/run-jots#configure-the-database) called `notifications` which generates personal notifications from onchain Jots activities. The notification database will be an offchain WeaveDB instance and will not be recorded on the blockchain. Not all data needs to be on the blockchain. Offchain plugins allow keeping some data off the chain. WeaveDB can seamlessly run in multiple environment such as blockchain, offchain (local), browser and centralized cloud.

## Explorer

If you are running the rollup node on `localhost:8080`, you can view blocks and transactions on our public [WeaveDB Scan](https://scan.weavedb.dev/node/localhost).