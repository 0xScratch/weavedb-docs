import { Callout } from 'nextra/components'
import { Tabs, Tab } from 'nextra/components'

# Run Local Test with WeaveDB Tools

- `weavedb-tools` is a command-line utility. It provides a set of commands to facilitate the process of setting up a local WeaveDB instance.

- Before deploying your WeaveDB instance to the main network, it is recommended to first deploy it locally on your machine for testing. This will help you catch any issues early on, reducing risks in your production environment.

## Install WeaveDB Tools

<Tabs items={['yarn', 'npm']}>
  <Tab>
  ```bash copy
sudo yarn global add weavedb-tools
  ```
  </Tab>
  <Tab>
  ```bash copy
sudo npm -g install weavedb-tools
  ```
  </Tab>
</Tabs>

Now, you can use the `weavedb` global command.

## Create a Project

```bash copy
weavedb create your_project
cd your_project
```

<Callout type="info" emoji="ðŸ’¡">
Use your own project name instead of `your_project`.
</Callout>

## Write DB Settings

Open your project in Visual Studio Code or your preferred code editor.

Within your project root directory, you'll find a `db` folder. This folder contains configuration files that define the database settings. You will be working with several files to set up [schemas](/sdk/schemas), [indexes](/sdk/indexes), [rules](/sdk/rules), [relayers](/sdk/relayers), [triggers](/sdk/triggers), and [crons](/sdk/crons) based on your app's architecture.

Let's build a simple app where users can post and delete messages. Below are the components you would typically configure:

### Schemas

[Schemas](/sdk/schemas) define the structure of your data. In this example, we will define a single collection called `posts` with required fields: `id`, `body`, `owner`, and `date`.

```js copy filename="/db/schemas.js"
module.exports = {
  posts: {
    type: "object",
    required: ["id", "body", "owner", "date"],
    properties: {
      id: { type: "string" },
      description: { type: "string" },
      owner: { type: "string" },
      date: { type: "number" },
    },
  },
}
```

### Indexes

[Indexes](/sdk/indexes) enable efficient data fetching. In this example, the index setting is automatically applied by default whenever you fetch data from the `posts` collection using the `get` or `cget` function queries of the SDK. The data will be sorted by `owner` and then by `date` in descending order.

```js copy filename="/db/indexes.js"
module.exports = {
  posts: [
    [["owner"], ["date", "desc"]], // sort by owner, then date
  ],
}
```

### Access Control Rules

[Access Control Rules](/sdk/rules) specify who can do what with the data. It defines the permission for interacting with the data, specifying which actions can be performed by whom.

FPJSON 2.0 simplifies access control rules and allows for the creation of custom queries, making them more powerful and flexible. In this example, we set up a custom query called `add:post` and set up data validation rules. Users will only need to input the `body` field, while the `id`, `owner`, and `date` fields are generated automatically during access validation.

```js copy filename="/db/rules.js"
module.exports = {
  posts: [
    [
      "add:post", // define a custom query
      [
        ["fields()", ["*body"]], // only allow "body" field, * makes it mandatory
        [
          "mod()", // auto assign some fields
          {
            id: "$id", // tx id
            owner: "$signer", // tx signer
            date: "$ms", // tx date in millisecond
          },
        ],
        ["allow()"], // allow the query
      ],
    ],
    [
      "delete:post", // define a custom query for deletion
      [ // "=$" will assign the result of the following FPJSON to a variable
        ["=$isOwner", ["equals", "$signer", "$old.owner"]], // check if signer is data owner
        ["allowifall()", ["$isOwner"]], // allow the query if $isOwner is true
      ],
    ],
  ],
}
```

## Run Local Test

As you configure your database settings, it is important to write corresponding tests. Using `weavedb-tools`, WeaveDB runs off-chain, allowing for significantly faster test execution.

In this example, we've written our tests in the `/test/test.js` file.

```js copy filename="/test/test.js"
  it("should execute queries", async () => {
    // add a post
    const tx = await db.query("add:post", { body: "test" }, "posts", userAuth)
    expect(await db.get("posts", tx.docID)).to.eql({
      body: "test",
      id: tx.docID, // auto-assigned
      owner: user.address.toLowerCase(), // auto-assigned
      date: tx.transaction.timestamp, // auto-assigned
    })
    // delete the post by the same user
    await db.query("delete:post", "posts", tx.docID, userAuth)
    expect(await db.get("posts", tx.docID)).to.eql(null)
  })
```

To run the tests, open your terminal, navigate to your project's root directory, and execute the following command:

<Tabs items={['yarn', 'npm']}>
  <Tab>
  ```bash copy
yarn test
  ```
  </Tab>
  <Tab>
  ```bash copy
npm test
  ```
  </Tab>
</Tabs>